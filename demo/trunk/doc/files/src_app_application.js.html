<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/app/application.js - dwv</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="dwv" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/dwv.App.html">dwv.App</a></li>
                                <li><a href="../classes/dwv.browser.html">dwv.browser</a></li>
                                <li><a href="../classes/dwv.dicom.DataReader.html">dwv.dicom.DataReader</a></li>
                                <li><a href="../classes/dwv.dicom.DicomParser.html">dwv.dicom.DicomParser</a></li>
                                <li><a href="../classes/dwv.gui.html">dwv.gui</a></li>
                                <li><a href="../classes/dwv.gui.base.html">dwv.gui.base</a></li>
                                <li><a href="../classes/dwv.gui.base.DicomTags.html">dwv.gui.base.DicomTags</a></li>
                                <li><a href="../classes/dwv.gui.base.Draw.html">dwv.gui.base.Draw</a></li>
                                <li><a href="../classes/dwv.gui.base.FileLoad.html">dwv.gui.base.FileLoad</a></li>
                                <li><a href="../classes/dwv.gui.base.Filter.html">dwv.gui.base.Filter</a></li>
                                <li><a href="../classes/dwv.gui.base.Livewire.html">dwv.gui.base.Livewire</a></li>
                                <li><a href="../classes/dwv.gui.base.Loadbox.html">dwv.gui.base.Loadbox</a></li>
                                <li><a href="../classes/dwv.gui.base.Scroll.html">dwv.gui.base.Scroll</a></li>
                                <li><a href="../classes/dwv.gui.base.Sharpen.html">dwv.gui.base.Sharpen</a></li>
                                <li><a href="../classes/dwv.gui.base.Slider.html">dwv.gui.base.Slider</a></li>
                                <li><a href="../classes/dwv.gui.base.Sobel.html">dwv.gui.base.Sobel</a></li>
                                <li><a href="../classes/dwv.gui.base.Threshold.html">dwv.gui.base.Threshold</a></li>
                                <li><a href="../classes/dwv.gui.base.Toolbox.html">dwv.gui.base.Toolbox</a></li>
                                <li><a href="../classes/dwv.gui.base.Undo.html">dwv.gui.base.Undo</a></li>
                                <li><a href="../classes/dwv.gui.base.WindowLevel.html">dwv.gui.base.WindowLevel</a></li>
                                <li><a href="../classes/dwv.gui.base.ZoomAndPan.html">dwv.gui.base.ZoomAndPan</a></li>
                                <li><a href="../classes/dwv.html.html">dwv.html</a></li>
                                <li><a href="../classes/dwv.html.Layer.html">dwv.html.Layer</a></li>
                                <li><a href="../classes/dwv.html.Style.html">dwv.html.Style</a></li>
                                <li><a href="../classes/dwv.image.html">dwv.image</a></li>
                                <li><a href="../classes/dwv.image.filter.Sharpen.html">dwv.image.filter.Sharpen</a></li>
                                <li><a href="../classes/dwv.image.filter.Sobel.html">dwv.image.filter.Sobel</a></li>
                                <li><a href="../classes/dwv.image.filter.Threshold.html">dwv.image.filter.Threshold</a></li>
                                <li><a href="../classes/dwv.image.Geometry.html">dwv.image.Geometry</a></li>
                                <li><a href="../classes/dwv.image.Image.html">dwv.image.Image</a></li>
                                <li><a href="../classes/dwv.image.ImageFactory.html">dwv.image.ImageFactory</a></li>
                                <li><a href="../classes/dwv.image.lut.Rescale.html">dwv.image.lut.Rescale</a></li>
                                <li><a href="../classes/dwv.image.lut.Window.html">dwv.image.lut.Window</a></li>
                                <li><a href="../classes/dwv.image.RescaleSlopeAndIntercept.html">dwv.image.RescaleSlopeAndIntercept</a></li>
                                <li><a href="../classes/dwv.image.Size.html">dwv.image.Size</a></li>
                                <li><a href="../classes/dwv.image.Spacing.html">dwv.image.Spacing</a></li>
                                <li><a href="../classes/dwv.image.View.html">dwv.image.View</a></li>
                                <li><a href="../classes/dwv.image.ViewFactory.html">dwv.image.ViewFactory</a></li>
                                <li><a href="../classes/dwv.info.html">dwv.info</a></li>
                                <li><a href="../classes/dwv.info.MiniColourMap.html">dwv.info.MiniColourMap</a></li>
                                <li><a href="../classes/dwv.info.Plot.html">dwv.info.Plot</a></li>
                                <li><a href="../classes/dwv.info.Position.html">dwv.info.Position</a></li>
                                <li><a href="../classes/dwv.info.WindowLevel.html">dwv.info.WindowLevel</a></li>
                                <li><a href="../classes/dwv.io.html">dwv.io</a></li>
                                <li><a href="../classes/dwv.io.File.html">dwv.io.File</a></li>
                                <li><a href="../classes/dwv.io.Url.html">dwv.io.Url</a></li>
                                <li><a href="../classes/dwv.math.html">dwv.math</a></li>
                                <li><a href="../classes/dwv.math.BucketQueue.html">dwv.math.BucketQueue</a></li>
                                <li><a href="../classes/dwv.math.Circle.html">dwv.math.Circle</a></li>
                                <li><a href="../classes/dwv.math.Ellipse.html">dwv.math.Ellipse</a></li>
                                <li><a href="../classes/dwv.math.FastPoint2D.html">dwv.math.FastPoint2D</a></li>
                                <li><a href="../classes/dwv.math.IdGenerator.html">dwv.math.IdGenerator</a></li>
                                <li><a href="../classes/dwv.math.Index3D.html">dwv.math.Index3D</a></li>
                                <li><a href="../classes/dwv.math.Line.html">dwv.math.Line</a></li>
                                <li><a href="../classes/dwv.math.Path.html">dwv.math.Path</a></li>
                                <li><a href="../classes/dwv.math.Point2D.html">dwv.math.Point2D</a></li>
                                <li><a href="../classes/dwv.math.Point3D.html">dwv.math.Point3D</a></li>
                                <li><a href="../classes/dwv.math.Rectangle.html">dwv.math.Rectangle</a></li>
                                <li><a href="../classes/dwv.math.ROI.html">dwv.math.ROI</a></li>
                                <li><a href="../classes/dwv.math.Scissors.html">dwv.math.Scissors</a></li>
                                <li><a href="../classes/dwv.State.html">dwv.State</a></li>
                                <li><a href="../classes/dwv.tool.html">dwv.tool</a></li>
                                <li><a href="../classes/dwv.tool.ChangeGroupCommand.html">dwv.tool.ChangeGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.DeleteGroupCommand.html">dwv.tool.DeleteGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.Draw.html">dwv.tool.Draw</a></li>
                                <li><a href="../classes/dwv.tool.DrawGroupCommand.html">dwv.tool.DrawGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.EllipseFactory.html">dwv.tool.EllipseFactory</a></li>
                                <li><a href="../classes/dwv.tool.Filter.html">dwv.tool.Filter</a></li>
                                <li><a href="../classes/dwv.tool.filter.Sharpen.html">dwv.tool.filter.Sharpen</a></li>
                                <li><a href="../classes/dwv.tool.filter.Sobel.html">dwv.tool.filter.Sobel</a></li>
                                <li><a href="../classes/dwv.tool.filter.Threshold.html">dwv.tool.filter.Threshold</a></li>
                                <li><a href="../classes/dwv.tool.LineFactory.html">dwv.tool.LineFactory</a></li>
                                <li><a href="../classes/dwv.tool.Livewire.html">dwv.tool.Livewire</a></li>
                                <li><a href="../classes/dwv.tool.MoveGroupCommand.html">dwv.tool.MoveGroupCommand</a></li>
                                <li><a href="../classes/dwv.tool.ProtractorFactory.html">dwv.tool.ProtractorFactory</a></li>
                                <li><a href="../classes/dwv.tool.RectangleFactory.html">dwv.tool.RectangleFactory</a></li>
                                <li><a href="../classes/dwv.tool.RoiFactory.html">dwv.tool.RoiFactory</a></li>
                                <li><a href="../classes/dwv.tool.RunFilterCommand.html">dwv.tool.RunFilterCommand</a></li>
                                <li><a href="../classes/dwv.tool.Scroll.html">dwv.tool.Scroll</a></li>
                                <li><a href="../classes/dwv.tool.ShapeEditor.html">dwv.tool.ShapeEditor</a></li>
                                <li><a href="../classes/dwv.tool.Toolbox.html">dwv.tool.Toolbox</a></li>
                                <li><a href="../classes/dwv.tool.UndoStack.html">dwv.tool.UndoStack</a></li>
                                <li><a href="../classes/dwv.tool.WindowLevel.html">dwv.tool.WindowLevel</a></li>
                                <li><a href="../classes/dwv.tool.ZoomAndPan.html">dwv.tool.ZoomAndPan</a></li>
                                <li><a href="../classes/dwv.ToolboxController.html">dwv.ToolboxController</a></li>
                                <li><a href="../classes/dwv.utils.html">dwv.utils</a></li>
                                <li><a href="../classes/dwv.ViewController.html">dwv.ViewController</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/browser.html">browser</a></li>
                                <li><a href="../modules/dicom.html">dicom</a></li>
                                <li><a href="../modules/gui.html">gui</a></li>
                                <li><a href="../modules/html.html">html</a></li>
                                <li><a href="../modules/image.html">image</a></li>
                                <li><a href="../modules/info.html">info</a></li>
                                <li><a href="../modules/io.html">io</a></li>
                                <li><a href="../modules/math.html">math</a></li>
                                <li><a href="../modules/tool.html">tool</a></li>
                                <li><a href="../modules/utils.html">utils</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/app/application.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
// Main DWV namespace.
var dwv = dwv || {};

var Kinetic = Kinetic || {};

/**
 * Main application class.
 * @class App
 * @namespace dwv
 * @constructor
 */
dwv.App = function ()
{
    // Local object
    var self = this;
    
    // Image
    var image = null;
    // Original image
    var originalImage = null;
    // Image data array
    var imageData = null;
    // Image data width
    var dataWidth = 0;
    // Image data height
    var dataHeight = 0;
    // Number of slices to load
    var nSlicesToLoad = 0;

    // Container div id
    var containerDivId = null;
    // Display window scale
    var windowScale = 1;
    // Fit display to window flag
    var fitToWindow = false;

    // View
    var view = null;
    // View controller
    var viewController = null;
     
    // Info layer plot gui
    var plotInfo = null;
    // Info layer windowing gui
    var windowingInfo = null;
    // Info layer position gui
    var positionInfo = null;
    // Info layer colour map gui
    var miniColourMap = null; 
    // flag to know if the info layer is listening on the image.
    var isInfoLayerListening = false;

    // Dicom tags gui
    var tagsGui = null;
    
    // Image layer
    var imageLayer = null;
    // Draw layers
    var drawLayers = [];
    // Draw stage
    var drawStage = null;
    
    // Toolbox
    var toolbox = null;
    // Toolbox controller
    var toolboxController = null;

    // Loadbox
    var loadbox = null;
    // UndoStack
    var undoStack = null;
    
    /** 
     * Get the version of the application.
     * @method getVersion
     * @return {String} The version of the application.
     */
    this.getVersion = function () { return &quot;v0.9.0&quot;; };
    
    /** 
     * Get the image.
     * @method getImage
     * @return {Image} The associated image.
     */
    this.getImage = function () { return image; };
    /** 
     * Set the view.
     * @method setImage
     * @param {Image} img The associated image.
     */
    this.setImage = function (img)
    { 
        image = img; 
        view.setImage(img);
    };
    /** 
     * Restore the original image.
     * @method restoreOriginalImage
     */
    this.restoreOriginalImage = function () 
    { 
        image = originalImage; 
        view.setImage(originalImage); 
    }; 
    /** 
     * Get the image data array.
     * @method getImageData
     * @return {Array} The image data array.
     */
    this.getImageData = function () { return imageData; };
    /** 
     * Get the number of slices to load.
     * @method getNSlicesToLoad
     * @return {Number} The number of slices to load.
     */
    this.getNSlicesToLoad = function () { return nSlicesToLoad; };

    /** 
     * Get the container div id.
     * @method getContainerDivId
     * @return {String} The div id.
     */
    this.getContainerDivId = function () { return containerDivId; };

    /** 
     * Get the view controller.
     * @method getViewController
     * @return {Object} The controller.
     */
    this.getViewController = function () { return viewController; };

    /** 
     * Get the image layer.
     * @method getImageLayer
     * @return {Object} The image layer.
     */
    this.getImageLayer = function () { return imageLayer; };
    /** 
     * Get the draw layer.
     * @method getDrawLayer
     * @return {Object} The draw layer.
     */
    this.getDrawLayer = function () { 
        return drawLayers[view.getCurrentPosition().k];
    };
    /** 
     * Get the draw stage.
     * @method getDrawStage
     * @return {Object} The draw layer.
     */
    this.getDrawStage = function () { return drawStage; };

    /** 
     * Get the toolbox.
     * @method getToolbox
     * @return {Object} The associated toolbox.
     */
    this.getToolbox = function () { return toolbox; };
    /** 
     * Get the toolbox controller.
     * @method getToolboxController
     * @return {Object} The controller.
     */
    this.getToolboxController = function () { return toolboxController; };

    /** 
     * Get the undo stack.
     * @method getUndoStack
     * @return {Object} The undo stack.
     */
    this.getUndoStack = function () { return undoStack; };

    /** 
     * Get the data loaders.
     * @method getLoaders
     * @return {Object} The loaders.
     */
    this.getLoaders = function () 
    {
        return {
            &#x27;file&#x27;: dwv.io.File,
            &#x27;url&#x27;: dwv.io.Url
        };        
    };
    
    /**
     * Initialise the HTML for the application.
     * @method init
     */
    this.init = function ( config ) {
        containerDivId = config.containerDivId;
        // tools
        if ( config.tools &amp;&amp; config.tools.length !== 0 ) {
            // setup the tool list
            var toolList = {};
            for ( var t = 0; t &lt; config.tools.length; ++t ) {
                switch( config.tools[t] ) {
                case &quot;Window/Level&quot;:
                    toolList[&quot;Window/Level&quot;] = new dwv.tool.WindowLevel(this);
                    break;
                case &quot;Zoom/Pan&quot;:
                    toolList[&quot;Zoom/Pan&quot;] = new dwv.tool.ZoomAndPan(this);
                    break;
                case &quot;Scroll&quot;:
                    toolList.Scroll = new dwv.tool.Scroll(this);
                    break;
                case &quot;Draw&quot;:
                    if ( config.shapes !== 0 ) {
                        // setup the shape list
                        var shapeList = {};
                        for ( var s = 0; s &lt; config.shapes.length; ++s ) {
                            switch( config.shapes[s] ) {
                            case &quot;Line&quot;:
                                shapeList.Line = dwv.tool.LineFactory;
                                break;
                            case &quot;Protractor&quot;:
                                shapeList.Protractor = dwv.tool.ProtractorFactory;
                                break;
                            case &quot;Rectangle&quot;:
                                shapeList.Rectangle = dwv.tool.RectangleFactory;
                                break;
                            case &quot;Roi&quot;:
                                shapeList.Roi = dwv.tool.RoiFactory;
                                break;
                            case &quot;Ellipse&quot;:
                                shapeList.Ellipse = dwv.tool.EllipseFactory;
                                break;
                            }
                        }
                        toolList.Draw = new dwv.tool.Draw(this, shapeList);
                    }
                    break;
                case &quot;Livewire&quot;:
                    toolList.Livewire = new dwv.tool.Livewire(this);
                    break;
                case &quot;Filter&quot;:
                    if ( config.filters.length !== 0 ) {
                        // setup the filter list
                        var filterList = {};
                        for ( var f = 0; f &lt; config.filters.length; ++f ) {
                            switch( config.filters[f] ) {
                            case &quot;Threshold&quot;:
                                filterList.Threshold = new dwv.tool.filter.Threshold(this);
                                break;
                            case &quot;Sharpen&quot;:
                                filterList.Sharpen = new dwv.tool.filter.Sharpen(this);
                                break;
                            case &quot;Sobel&quot;:
                                filterList.Sobel = new dwv.tool.filter.Sobel(this);
                                break;
                            }
                        }
                        toolList.Filter = new dwv.tool.Filter(filterList, this);
                    }
                    break;
                default:
                    throw new Error(&quot;Unknown tool: &#x27;&quot; + config.tools[t] + &quot;&#x27;&quot;);
                }
            }
            toolbox = new dwv.tool.Toolbox(toolList, this);
            toolboxController = new dwv.ToolboxController(toolbox);
        }
        // gui
        if ( config.gui ) {
            // tools
            if ( config.gui.indexOf(&quot;tool&quot;) !== -1 &amp;&amp; toolbox) {
                toolbox.setup();
            }
            // load
            if ( config.gui.indexOf(&quot;load&quot;) !== -1 ) {
                var fileLoadGui = new dwv.gui.FileLoad(this);
                var urlLoadGui = new dwv.gui.UrlLoad(this);
                loadbox = new dwv.gui.Loadbox(this, 
                    {&quot;file&quot;: fileLoadGui, &quot;url&quot;: urlLoadGui} );
                loadbox.setup();
                fileLoadGui.setup();
                urlLoadGui.setup();
                fileLoadGui.display(true);
                urlLoadGui.display(false);
            }
            // undo
            if ( config.gui.indexOf(&quot;undo&quot;) !== -1 ) {
                undoStack = new dwv.tool.UndoStack();
                undoStack.setup();
            }
            // DICOM Tags
            if ( config.gui.indexOf(&quot;tags&quot;) !== -1 ) {
                tagsGui = new dwv.gui.DicomTags();
            }
            // version number
            if ( config.gui.indexOf(&quot;version&quot;) !== -1 ) {
                dwv.gui.appendVersionHtml(this.getVersion());
            }
            // help
            if ( config.gui.indexOf(&quot;help&quot;) !== -1 ) {
                var isMobile = true;
                if ( config.isMobile ) {
                    isMobile = config.isMobile;
                }
                dwv.gui.appendHelpHtml( toolbox.getToolList(), isMobile );
            }
        }
        
        // listen to drag&amp;drop
        var dropBoxDivId = containerDivId + &quot;-dropBox&quot;;
        var box = document.getElementById(dropBoxDivId);
        if ( box ) {
            box.addEventListener(&quot;dragover&quot;, onDragOver);
            box.addEventListener(&quot;dragleave&quot;, onDragLeave);
            box.addEventListener(&quot;drop&quot;, onDrop);
            // initial size
            var size = dwv.gui.getWindowSize();
            var dropBoxSize = 2 * size.height / 3;
            $(&quot;#&quot;+dropBoxDivId).height( dropBoxSize );
            $(&quot;#&quot;+dropBoxDivId).width( dropBoxSize );
        }
        // possible load from URL
        if ( typeof config.skipLoadUrl === &quot;undefined&quot; ) {
            dwv.html.getUriParam(window.location.href, this.onInputURLs); 
        }
        else{
            console.log(&quot;Not loading url from adress since skipLoadUrl is defined.&quot;);
        }
        // align layers when the window is resized
        if ( config.fitToWindow ) {
            fitToWindow = true;
            window.onresize = this.onResize;
        }
    };
    
    /**
     * Reset the application.
     * @method reset
     */
    this.reset = function ()
    {
        // clear tools
        if ( toolbox ) {
            toolbox.reset();
        }
        // clear draw
        if ( drawStage ) {
            drawLayers = [];
        }
        // clear objects
        image = null;
        view = null;
        nSlicesToLoad = 0;
        // reset undo/redo
        if ( undoStack ) {
            undoStack = new dwv.tool.UndoStack();
            undoStack.initialise();
        }
    };
    
    /**
     * Reset the layout of the application.
     * @method resetLayout
     */
    this.resetLayout = function () {
        if ( imageLayer ) {
            imageLayer.resetLayout(windowScale);
            imageLayer.draw();
        }
        if ( drawStage ) {
            drawStage.offset( {&#x27;x&#x27;: 0, &#x27;y&#x27;: 0} );
            drawStage.scale( {&#x27;x&#x27;: windowScale, &#x27;y&#x27;: windowScale} );
            drawStage.draw();
        }
    };
    
    /**
     * Load a list of files.
     * @method loadFiles
     * @param {Array} files The list of files to load.
     */
    this.loadFiles = function (files)
    {
        // has been checked for emptiness.
        var ext = files[0].name.split(&#x27;.&#x27;).pop().toLowerCase();
        if ( ext === &quot;json&quot; ) {
            loadJSONFile(files);
        }
        else {
            loadImageFiles(files);
        }
    };

    /**
     * Load a list of files.
     * @method loadFiles
     * @param {Array} files The list of files to load.
     */
    function loadImageFiles (files) 
    {
        // clear variables
        self.reset();
        nSlicesToLoad = files.length;
        // create IO
        var fileIO = new dwv.io.File();
        fileIO.onload = function (data) {
            
            var isFirst = true;
            if ( image ) {
                view.append( data.view );
                isFirst = false;
            }
            postLoadInit(data);
            if ( drawStage ) {
                // create slice draw layer
                var drawLayer = new Kinetic.Layer({
                    listening: false,
                    hitGraphEnabled: false,
                    visible: isFirst
                });
                // add to layers array
                drawLayers.push(drawLayer);
                // add the layer to the stage
                drawStage.add(drawLayer);
            }
        };
        fileIO.onerror = function (error){ handleError(error); };
        // main load (asynchronous)
        fileIO.load(files);
    }
    
    /**
     * Load a JSON file.
     * @method loadJSON
     * @param {Array} file An array with the file to load.
     */
    function loadJSONFile(file) 
    {
        // create IO
        var fileIO = new dwv.io.File();
        fileIO.onload = function (data) {
            // load state
            var state = new dwv.State(self);
            state.fromJSON(data);
        };
        fileIO.onerror = function (error){ handleError(error); };
        // main load (asynchronous)
        fileIO.load(file);
    }

    /**
     * Load a list of URLs.
     * @method loadURL
     * @param {Array} urls The list of urls to load.
     */
    this.loadURL = function(urls) 
    {
        // clear variables
        this.reset();
        nSlicesToLoad = urls.length;
        // create IO
        var urlIO = new dwv.io.Url();
        urlIO.onload = function (data) {
            var isFirst = true;
            if ( image ) {
                view.append( data.view );
                isFirst = false;
            }
            postLoadInit(data);
            if ( drawStage ) {
                // create slice draw layer
                var drawLayer = new Kinetic.Layer({
                    listening: false,
                    hitGraphEnabled: false,
                    visible: isFirst
                });
                // add to layers array
                drawLayers.push(drawLayer);
                // add the layer to the stage
                drawStage.add(drawLayer);
            }
        };
        urlIO.onerror = function (error){ handleError(error); };
        // main load (asynchronous)
        urlIO.load(urls);
    };
    
    /**
     * Fit the display to the given size. To be called once the image is loaded.
     * @method fitToSize
     */
    this.fitToSize = function (size)
    {
        // previous width
        var oldWidth = parseInt(windowScale*dataWidth, 10);
        // find new best fit
        windowScale = Math.min( (size.width / dataWidth), (size.height / dataHeight) );
        // new sizes
        var newWidth = parseInt(windowScale*dataWidth, 10);
        var newHeight = parseInt(windowScale*dataHeight, 10);
        // ratio previous/new to add to zoom
        var mul = newWidth / oldWidth;

        // resize container
        var jqDivId = &quot;#&quot;+containerDivId;
        $(jqDivId).width(newWidth);
        $(jqDivId).height(newHeight);
        // resize image layer
        if ( imageLayer ) {
            var iZoomX = imageLayer.getZoom().x * mul;
            var iZoomY = imageLayer.getZoom().y * mul;
            imageLayer.setWidth(newWidth);
            imageLayer.setHeight(newHeight);
            imageLayer.zoom(iZoomX, iZoomY, 0, 0);
            imageLayer.draw();
        }
        // resize draw stage
        if ( drawStage ) {
            // resize div
            var drawDivId = &quot;#&quot; + containerDivId + &quot;-drawDiv&quot;;
            $(drawDivId).width(newWidth);
            $(drawDivId).height(newHeight);
            // resize stage
            var stageZomX = drawStage.scale().x * mul;
            var stageZoomY = drawStage.scale().y * mul;
            drawStage.setWidth(newWidth);
            drawStage.setHeight(newHeight);
            drawStage.scale( {x: stageZomX, y: stageZoomY} );
            drawStage.draw();
        }
    };
    
    /**
     * Toggle the display of the information layer.
     * @method toggleInfoLayerDisplay
     */
    this.toggleInfoLayerDisplay = function ()
    {
        // toggle html
        var infoDivId = containerDivId + &quot;-infoLayer&quot;;
        dwv.html.toggleDisplay(infoDivId);
        // toggle listeners
        if ( isInfoLayerListening ) {
            removeImageInfoListeners();
        }
        else {
            addImageInfoListeners();
        }
    };
    
    /**
     * Init the Window/Level display
     */
    this.initWLDisplay = function ()
    {
        // set window/level from first preset
        var presets = viewController.getPresets();
        var keys = Object.keys(presets);
        viewController.setWindowLevel(
            presets[keys[0]].center, 
            presets[keys[0]].width );
        // default position
        viewController.setCurrentPosition2D(0,0);
    };

    /**
     * Add layer mouse and touch listeners.
     * @method addLayerListeners
     */
    this.addLayerListeners = function (layer)
    {
        // allow pointer events
        layer.setAttribute(&quot;style&quot;, &quot;pointer-events: auto;&quot;);
        // mouse listeners
        layer.addEventListener(&quot;mousedown&quot;, eventHandler);
        layer.addEventListener(&quot;mousemove&quot;, eventHandler);
        layer.addEventListener(&quot;mouseup&quot;, eventHandler);
        layer.addEventListener(&quot;mouseout&quot;, eventHandler);
        layer.addEventListener(&quot;mousewheel&quot;, eventHandler);
        layer.addEventListener(&quot;DOMMouseScroll&quot;, eventHandler);
        layer.addEventListener(&quot;dblclick&quot;, eventHandler);
        // touch listeners
        layer.addEventListener(&quot;touchstart&quot;, eventHandler);
        layer.addEventListener(&quot;touchmove&quot;, eventHandler);
        layer.addEventListener(&quot;touchend&quot;, eventHandler);
    };
    
    /**
     * Remove layer mouse and touch listeners.
     * @method removeLayerListeners
     */
    this.removeLayerListeners = function (layer)
    {
        // disable pointer events
        layer.setAttribute(&quot;style&quot;, &quot;pointer-events: none;&quot;);
        // mouse listeners
        layer.removeEventListener(&quot;mousedown&quot;, eventHandler);
        layer.removeEventListener(&quot;mousemove&quot;, eventHandler);
        layer.removeEventListener(&quot;mouseup&quot;, eventHandler);
        layer.removeEventListener(&quot;mouseout&quot;, eventHandler);
        layer.removeEventListener(&quot;mousewheel&quot;, eventHandler);
        layer.removeEventListener(&quot;DOMMouseScroll&quot;, eventHandler);
        layer.removeEventListener(&quot;dblclick&quot;, eventHandler);
        // touch listeners
        layer.removeEventListener(&quot;touchstart&quot;, eventHandler);
        layer.removeEventListener(&quot;touchmove&quot;, eventHandler);
        layer.removeEventListener(&quot;touchend&quot;, eventHandler);
    };
    
    /**
     * Render the current image.
     * @method render
     */
    this.render = function ()
    {
        generateAndDrawImage();
    };
    
    // Handler Methods -----------------------------------------------------------

    /**
     * Handle window/level change.
     * @method onWLChange
     * @param {Object} event The event fired when changing the window/level.
     */
    this.onWLChange = function (/*event*/)
    {         
        generateAndDrawImage();
    };

    /**
     * Handle colour map change.
     * @method onColourChange
     * @param {Object} event The event fired when changing the colour map.
     */
    this.onColourChange = function (/*event*/)
    {  
        generateAndDrawImage();
    };

    /**
     * Handle slice change.
     * @method onSliceChange
     * @param {Object} event The event fired when changing the slice.
     */
    this.onSliceChange = function (/*event*/)
    {   
        generateAndDrawImage();
        if ( drawStage ) {
            // hide all draw layers
            for ( var i = 0; i &lt; drawLayers.length; ++i ) {
                drawLayers[i].visible( false );
            }
            // show current draw layer
            var currentLayer = drawLayers[view.getCurrentPosition().k];
            currentLayer.visible( true );
            currentLayer.draw();
        }
    };

    /**
     * Handle key down event.
     * - CRTL-Z: undo
     * - CRTL-Y: redo
     * Default behavior. Usually used in tools. 
     * @method onKeydown
     * @param {Object} event The key down event.
     */
    this.onKeydown = function (event)
    {
        if ( event.keyCode === 90 &amp;&amp; event.ctrlKey ) // ctrl-z
        {
            undoStack.undo();
        }
        else if ( event.keyCode === 89 &amp;&amp; event.ctrlKey ) // ctrl-y
        {
            undoStack.redo();
        }
    };
    
    /**
     * Handle resize.
     * Fit the display to the window. To be called once the image is loaded.
     * @method onResize
     * @param {Object} event The change event.
     */
    this.onResize = function (/*event*/)
    {
        self.fitToSize(dwv.gui.getWindowSize());
    };
    
    /**
     * Handle zoom reset.
     * @method onZoomReset
     * @param {Object} event The change event.
     */
    this.onZoomReset = function (/*event*/)
    {
        self.resetLayout();
    };

    /**
     * Handle loader change.
     * @method onChangeLoader
     * @param {Object} event The change event.
     */
    this.onChangeLoader = function (/*event*/)
    {
        loadbox.displayLoader( this.value );
    };

    /**
     * Handle change url event.
     * @method onChangeURL
     * @param {Object} event The event fired when changing the url field.
     */
    this.onChangeURL = function (event)
    {
        self.loadURL([event.target.value]);
    };

    /**
     * Handle input urls.
     * @method onInputURLs
     * @param {Array} urls The list of input urls.
     */
    this.onInputURLs = function (urls)
    {
        self.loadURL(urls);
    };

    /**
     * Handle change files event.
     * @method onChangeFiles
     * @param {Object} event The event fired when changing the file field.
     */
    this.onChangeFiles = function (event)
    {
        var files = event.target.files;
        if ( files.length !== 0 ) {
            self.loadFiles(files);
        }  
    };

    /**
     * Handle state save event.
     * @method onStateSave
     * @param {Object} event The event fired when changing the state save field.
     */
    this.onStateSave = function (/*event*/)
    {
        var state = new dwv.State(self);
        // add href to link (html5)
        var element = document.getElementById(&quot;download-state&quot;);
        element.href = &quot;data:application/json;charset=utf8;base64,&quot; + state.toJSON();
    };

    /**
     * Handle colour map change.
     * @method onChangeColourMap
     * @param {Object} event The change event.
     */
    this.onChangeColourMap = function (/*event*/)
    {
        viewController.setColourMapFromName(this.value);
    };

    /**
     * Handle window/level preset change.
     * @method onChangeWindowLevelPreset
     * @param {Object} event The change event.
     */
    this.onChangeWindowLevelPreset = function (/*event*/)
    {
        var name = this.value;
        var preset = viewController.getPresets()[name];
        // check if we have it
        if ( !preset ) {
            throw new Error(&quot;Unknown window level preset: &#x27;&quot; + name + &quot;&#x27;&quot;);
        }
        // enable it
        viewController.setWindowLevel( 
            preset.center, preset.width );
    };

    /**
     * Handle tool change.
     * @method onChangeTool
     * @param {Object} event The change event.
     */
    this.onChangeTool = function (/*event*/)
    {
        toolboxController.setSelectedTool(this.value);
    };

    /**
     * Handle shape change.
     * @method onChangeShape
     * @param {Object} event The change event.
     */
    this.onChangeShape = function (/*event*/)
    {
        toolboxController.setSelectedShape(this.value);
    };

    /**
     * Handle filter change.
     * @method onChangeFilter
     * @param {Object} event The change event.
     */
    this.onChangeFilter = function (/*event*/)
    {
        toolboxController.setSelectedFilter(this.value);
    };

    /**
     * Handle filter run.
     * @method onRunFilter
     * @param {Object} event The run event.
     */
    this.onRunFilter = function (/*event*/)
    {
        toolboxController.runSelectedFilter();
    };

    /**
     * Handle line colour change.
     * @method onChangeLineColour
     * @param {Object} event The change event.
     */
    this.onChangeLineColour = function (/*event*/)
    {
        toolboxController.setLineColour(this.value);
    };

    /**
     * Handle min/max slider change.
     * @method onChangeMinMax
     * @param {Object} range The new range of the data.
     */
    this.onChangeMinMax = function (range)
    {
        toolboxController.setRange(range);
    };

    /**
     * Handle undo.
     * @method onUndo
     * @param {Object} event The associated event.
     */
    this.onUndo = function (/*event*/)
    {
        undoStack.undo();
    };

    /**
     * Handle redo.
     * @method onRedo
     * @param {Object} event The associated event.
     */
    this.onRedo = function (/*event*/)
    {
        undoStack.redo();
    };

    /**
     * Handle toggle of info layer.
     * @method onToggleInfoLayer
     * @param {Object} event The associated event.
     */
    this.onToggleInfoLayer = function (/*event*/)
    {
        self.toggleInfoLayerDisplay();
    };
    
    /**
     * Handle display reset.
     * @method onDisplayReset
     * @param {Object} event The change event.
     */
    this.onDisplayReset = function (/*event*/)
    {
        self.resetLayout();
        self.initWLDisplay();
        // update preset select
        var select = document.getElementById(&quot;presetSelect&quot;);
        select.selectedIndex = 0;
        dwv.gui.refreshSelect(&quot;#presetSelect&quot;);
    };

    /**
     * Apply the zoom to the layers.
     * @method zoomLayers
     * @param {Number} step The zoom step increment. A good step is of 0.1.
     * @param {Number} cx The zoom center X coordinate.
     * @param {Number} cy The zoom center Y coordinate.
     */ 
    this.zoomLayers = function (step, cx, cy)
    {
        if( this.getImageLayer() ) {
            var layer = this.getImageLayer();
            var oldZoom = layer.getZoom();
            var newZoom = {&#x27;x&#x27;: (oldZoom.x + step), &#x27;y&#x27;: (oldZoom.y + step)};
            layer.zoom(newZoom.x, newZoom.y, cx, cy);
            layer.draw();
        }
        if( this.getDrawStage() ) { 
            
            var stage = this.getDrawStage();
            var oldKZoom = stage.scale();
            var newKZoom = {&#x27;x&#x27;: (oldKZoom.x + step), &#x27;y&#x27;: (oldKZoom.y + step)};
            
            var oldOffset = stage.offset();
            var newOffsetX = (cx / oldKZoom.x) + oldOffset.x - (cx / newKZoom.x);
            var newOffsetY = (cy / oldKZoom.y) + oldOffset.y - (cy / newKZoom.y);
            var newOffset = { &#x27;x&#x27;: newOffsetX, &#x27;y&#x27;: newOffsetY };
            
            stage.offset( newOffset );
            stage.scale( newKZoom );
            stage.draw();
        }
    };

    /**
     * Apply a translation to the layers.
     * @method translateLayers
     * @param {Number} tx The translation along X.
     * @param {Number} ty The translation along Y.
     */ 
    this.translateLayers = function (tx, ty)
    {
        if( this.getImageLayer() ) {
            var layer = this.getImageLayer();
            var zoom = layer.getZoom();
            var txx = tx / zoom.x;
            var tyy = ty / zoom.y;
            layer.translate(txx, tyy);
            layer.draw();
        }
        if( this.getDrawStage() ) { 
            var stage = this.getDrawStage();
            var offset = stage.offset();
            var kzoom = stage.scale();
            offset.x -= tx / kzoom.x;
            offset.y -= ty / kzoom.y;
            stage.offset( offset );
            stage.draw();
        }
    };

    // Private Methods -----------------------------------------------------------

    /**
     * Generate the image data and draw it.
     * @method generateAndDrawImage
     */
    function generateAndDrawImage()
    {         
        // generate image data from DICOM
        view.generateImageData(imageData);         
        // set the image data of the layer
        imageLayer.setImageData(imageData);
        // draw the image
        imageLayer.draw();
    }
    
    /**
     * Add image listeners.
     * @method addImageInfoListeners
     * @private
     */
    function addImageInfoListeners()
    {
        view.addEventListener(&quot;wlchange&quot;, windowingInfo.update);
        view.addEventListener(&quot;wlchange&quot;, miniColourMap.update);
        view.addEventListener(&quot;wlchange&quot;, plotInfo.update);
        view.addEventListener(&quot;colourchange&quot;, miniColourMap.update);
        view.addEventListener(&quot;positionchange&quot;, positionInfo.update);
        isInfoLayerListening = true;
    }
    
    /**
     * Remove image listeners.
     * @method removeImageInfoListeners
     * @private
     */
    function removeImageInfoListeners()
    {
        view.removeEventListener(&quot;wlchange&quot;, windowingInfo.update);
        view.removeEventListener(&quot;wlchange&quot;, miniColourMap.update);
        view.removeEventListener(&quot;wlchange&quot;, plotInfo.update);
        view.removeEventListener(&quot;colourchange&quot;, miniColourMap.update);
        view.removeEventListener(&quot;positionchange&quot;, positionInfo.update);
        isInfoLayerListening = false;
    }
    
    /**
     * General-purpose event handler. This function just determines the mouse 
     * position relative to the canvas element. It then passes it to the current tool.
     * @method eventHandler
     * @private
     * @param {Object} event The event to handle.
     */
    function eventHandler(event)
    {
        // flag not to get confused between touch and mouse
        var handled = false;
        // Store the event position relative to the image canvas
        // in an extra member of the event:
        // event._x and event._y.
        var offsets = null;
        var position = null;
        if ( event.type === &quot;touchstart&quot; ||
            event.type === &quot;touchmove&quot;)
        {
            event.preventDefault();
            // event offset(s)
            offsets = dwv.html.getEventOffset(event);
            // should have at least one offset
            event._xs = offsets[0].x;
            event._ys = offsets[0].y;
            position = self.getImageLayer().displayToIndex( offsets[0] );
            event._x = parseInt( position.x, 10 );
            event._y = parseInt( position.y, 10 );
            // possible second
            if ( offsets.length === 2 ) {
                event._x1s = offsets[1].x;
                event._y1s = offsets[1].y;
                position = self.getImageLayer().displayToIndex( offsets[1] );
                event._x1 = parseInt( position.x, 10 );
                event._y1 = parseInt( position.y, 10 );
            }
            // set handle event flag
            handled = true;
        }
        else if ( event.type === &quot;mousemove&quot; ||
            event.type === &quot;mousedown&quot; ||
            event.type === &quot;mouseup&quot; ||
            event.type === &quot;mouseout&quot; ||
            event.type === &quot;mousewheel&quot; ||
            event.type === &quot;dblclick&quot; ||
            event.type === &quot;DOMMouseScroll&quot; )
        {
            offsets = dwv.html.getEventOffset(event);
            event._xs = offsets[0].x;
            event._ys = offsets[0].y;
            position = self.getImageLayer().displayToIndex( offsets[0] );
            event._x = parseInt( position.x, 10 );
            event._y = parseInt( position.y, 10 );
            // set handle event flag
            handled = true;
        }
        else if ( event.type === &quot;keydown&quot; || 
                event.type === &quot;touchend&quot;)
        {
            handled = true;
        }
            
        // Call the event handler of the tool.
        if ( handled )
        {
            var func = self.getToolbox().getSelectedTool()[event.type];
            if ( func )
            {
                func(event);
            }
        }
    }
    
    /**
     * Handle a drag over.
     * @method onDragOver
     * @private
     * @param {Object} event The event to handle.
     */
    function onDragOver(event)
    {
        // prevent default handling
        event.stopPropagation();
        event.preventDefault();
        // update box 
        var dropBoxDivId = containerDivId + &quot;-dropBox&quot;;
        var box = document.getElementById(dropBoxDivId);
        if ( box ) {
            box.className = &#x27;dropBox hover&#x27;;
        }
    }
    
    /**
     * Handle a drag leave.
     * @method onDragLeave
     * @private
     * @param {Object} event The event to handle.
     */
    function onDragLeave(event)
    {
        // prevent default handling
        event.stopPropagation();
        event.preventDefault();
        // update box
        var dropBoxDivId = containerDivId + &quot;-dropBox&quot;;
        var box = document.getElementById(dropBoxDivId);
        if ( box ) {
            box.className = &#x27;dropBox&#x27;;
        }
    }

    /**
     * Handle a drop event.
     * @method onDrop
     * @private
     * @param {Object} event The event to handle.
     */
    function onDrop(event)
    {
        // prevent default handling
        event.stopPropagation();
        event.preventDefault();
        // load files
        self.loadFiles(event.dataTransfer.files);
    }

    /**
     * Handle an error: display it to the user.
     * @method handleError
     * @private
     * @param {Object} error The error to handle.
     */
    function handleError(error)
    {
        // alert window
        if ( error.name &amp;&amp; error.message) {
            alert(error.name+&quot;: &quot;+error.message+&quot;.&quot;);
        }
        else {
            alert(&quot;Error: &quot;+error+&quot;.&quot;);
        }
        // log
        if ( error.stack ) {
            console.error(error.stack);
        }
    }
    
    /**
     * Create the application layers.
     * @method createLayers
     * @private
     * @param {Number} dataWidth The width of the input data.
     * @param {Number} dataHeight The height of the input data.
     */
    function createLayers(dataWidth, dataHeight)
    {
        // image layer
        imageLayer = new dwv.html.Layer(containerDivId + &quot;-imageLayer&quot;);
        imageLayer.initialise(dataWidth, dataHeight);
        imageLayer.fillContext();
        imageLayer.setStyleDisplay(true);
        // draw layer
        var drawDivId = containerDivId + &quot;-drawDiv&quot;;
        if ( document.getElementById(drawDivId) !== null) {
            // create stage
            drawStage = new Kinetic.Stage({
                container: drawDivId,
                width: dataWidth,
                height: dataHeight,
                listening: false
            });
            // reset style
            // (avoids a not needed vertical scrollbar) 
            drawStage.getContent().setAttribute(&quot;style&quot;, &quot;&quot;);
        }
        // resize app
        if ( fitToWindow ) {
            self.fitToSize( dwv.gui.getWindowSize() );
        }
        else {
            self.fitToSize( { 
                &#x27;width&#x27;: $(&#x27;#&#x27;+containerDivId).width(), 
                &#x27;height&#x27;: $(&#x27;#&#x27;+containerDivId).height() } );
        }
        self.resetLayout();
    }
    
    /**
     * Post load application initialisation. To be called once the DICOM has been parsed.
     * @method postLoadInit
     * @private
     * @param {Object} data The data to display.
     */
    function postLoadInit(data)
    {
        // only initialise the first time
        if ( view ) {
            return;
        }
        
        // get the view from the loaded data
        view = data.view;
        viewController = new dwv.ViewController(view);
        // append the DICOM tags table
        if ( tagsGui ) {
            tagsGui.initialise(data.info);
        }
        // store image
        originalImage = view.getImage();
        image = originalImage;
        
        // layout
        var size = image.getGeometry().getSize();
        dataWidth = size.getNumberOfColumns();
        dataHeight = size.getNumberOfRows();
        createLayers(dataWidth, dataHeight);
        
        // get the image data from the image layer
        imageData = imageLayer.getContext().createImageData( 
                dataWidth, dataHeight);

        // image listeners
        view.addEventListener(&quot;wlchange&quot;, self.onWLChange);
        view.addEventListener(&quot;colourchange&quot;, self.onColourChange);
        view.addEventListener(&quot;slicechange&quot;, self.onSliceChange);
        
        // update presets with loaded image (used in w/l tool)
        viewController.updatePresets(image, true);

        // initialise the toolbox
        if ( toolbox ) {
            // mouse and touch listeners
            self.addLayerListeners( imageLayer.getCanvas() );
            // keydown listener
            window.addEventListener(&quot;keydown&quot;, eventHandler, true);
            
            toolbox.init();
            toolbox.display(true);
        }
        
        // stop box listening to drag (after first drag)
        var dropBoxDivId = containerDivId + &quot;-dropBox&quot;;
        var box = document.getElementById(dropBoxDivId);
        if ( box ) {
            box.removeEventListener(&quot;dragover&quot;, onDragOver);
            box.removeEventListener(&quot;dragleave&quot;, onDragLeave);
            box.removeEventListener(&quot;drop&quot;, onDrop);
            dwv.html.removeNode(dropBoxDivId);
            // switch listening to layerContainer
            var div = document.getElementById(containerDivId);
            div.addEventListener(&quot;dragover&quot;, onDragOver);
            div.addEventListener(&quot;dragleave&quot;, onDragLeave);
            div.addEventListener(&quot;drop&quot;, onDrop);
        }

        // info layer
        var infoDivId = containerDivId + &quot;-infoLayer&quot;;
        if ( document.getElementById(infoDivId) ) {
            windowingInfo = new dwv.info.Windowing(self);
            windowingInfo.create();
            
            positionInfo = new dwv.info.Position(self);
            positionInfo.create();
            
            miniColourMap = new dwv.info.MiniColourMap(self);
            miniColourMap.create();
            
            plotInfo = new dwv.info.Plot(self);
            plotInfo.create();
            
            addImageInfoListeners();
        }
        
        // init W/L display: triggers a wlchange event
        //   listened by the view and a general display.
        self.initWLDisplay();        
    }

};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
