<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/image/image.js - dwv</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="dwv"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.4.0beta</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/dwv.dicom.DataReader.html">dwv.dicom.DataReader</a></li>
            
                <li><a href="../classes/dwv.dicom.DicomParser.html">dwv.dicom.DicomParser</a></li>
            
                <li><a href="../classes/dwv.dicom.Dictionary.html">dwv.dicom.Dictionary</a></li>
            
                <li><a href="../classes/dwv.html.Image class..html">dwv.html.Image class.</a></li>
            
                <li><a href="../classes/dwv.html.Image Size class. 
Supports 2D and 3D images..html">dwv.html.Image Size class. 
Supports 2D and 3D images.</a></li>
            
                <li><a href="../classes/dwv.html.Image Spacing class. 
Supports 2D and 3D images..html">dwv.html.Image Spacing class. 
Supports 2D and 3D images.</a></li>
            
                <li><a href="../classes/dwv.html.Layer.html">dwv.html.Layer</a></li>
            
                <li><a href="../classes/dwv.html.Rescale LUT class..html">dwv.html.Rescale LUT class.</a></li>
            
                <li><a href="../classes/dwv.html.Style.html">dwv.html.Style</a></li>
            
                <li><a href="../classes/dwv.html.View class..html">dwv.html.View class.</a></li>
            
                <li><a href="../classes/dwv.html.Window LUT class..html">dwv.html.Window LUT class.</a></li>
            
                <li><a href="../classes/dwv.math.BucketQueue.html">dwv.math.BucketQueue</a></li>
            
                <li><a href="../classes/dwv.math.Circle.html">dwv.math.Circle</a></li>
            
                <li><a href="../classes/dwv.math.Draw circle command..html">dwv.math.Draw circle command.</a></li>
            
                <li><a href="../classes/dwv.math.Drawing tool..html">dwv.math.Drawing tool.</a></li>
            
                <li><a href="../classes/dwv.math.FastPoint2D.html">dwv.math.FastPoint2D</a></li>
            
                <li><a href="../classes/dwv.math.Line.html">dwv.math.Line</a></li>
            
                <li><a href="../classes/dwv.math.Path.html">dwv.math.Path</a></li>
            
                <li><a href="../classes/dwv.math.Point2D.html">dwv.math.Point2D</a></li>
            
                <li><a href="../classes/dwv.math.Rectangle.html">dwv.math.Rectangle</a></li>
            
                <li><a href="../classes/dwv.math.ROI.html">dwv.math.ROI</a></li>
            
                <li><a href="../classes/dwv.math.Scissors.html">dwv.math.Scissors</a></li>
            
                <li><a href="../classes/Filter classes..App
Main application..html">Filter classes..App
Main application.</a></li>
            
                <li><a href="../classes/Filter classes..Draw line command..html">Filter classes..Draw line command.</a></li>
            
                <li><a href="../classes/Filter classes..Draw livewire command..html">Filter classes..Draw livewire command.</a></li>
            
                <li><a href="../classes/Filter classes..Draw rectangle command..html">Filter classes..Draw rectangle command.</a></li>
            
                <li><a href="../classes/Filter classes..Draw ROI command..html">Filter classes..Draw ROI command.</a></li>
            
                <li><a href="../classes/Filter classes..Filter tool..html">Filter classes..Filter tool.</a></li>
            
                <li><a href="../classes/Filter classes..Livewire painting tool..html">Filter classes..Livewire painting tool.</a></li>
            
                <li><a href="../classes/Filter classes..Run filter command..html">Filter classes..Run filter command.</a></li>
            
                <li><a href="../classes/Filter classes..Sharpen filter tool..html">Filter classes..Sharpen filter tool.</a></li>
            
                <li><a href="../classes/Filter classes..Sobel filter tool..html">Filter classes..Sobel filter tool.</a></li>
            
                <li><a href="../classes/Filter classes..Threshold filter tool..html">Filter classes..Threshold filter tool.</a></li>
            
                <li><a href="../classes/Filter classes..Tool box..html">Filter classes..Tool box.</a></li>
            
                <li><a href="../classes/Filter classes..UndoStack class..html">Filter classes..UndoStack class.</a></li>
            
                <li><a href="../classes/Filter classes..WindowLevel tool: handle window/level related events..html">Filter classes..WindowLevel tool: handle window/level related events.</a></li>
            
                <li><a href="../classes/Filter classes..Zoom class..html">Filter classes..Zoom class.</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/dicom.html">dicom</a></li>
            
                <li><a href="../modules/math.html">math</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/image/image.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
//! @namespace Main DWV namespace.
var dwv = dwv || {};
//! @namespace Image related.
dwv.image = dwv.image || {};

/**
* @class Image Size class. 
* Supports 2D and 3D images.
* @param numberOfColumns The number of columns (number).
* @param numberOfRows The number of rows (number).
* @param numberOfSlices The number of slices (number).
*/
dwv.image.Size = function( numberOfColumns, numberOfRows, numberOfSlices )
{
    // Get the number of columns.
    this.getNumberOfColumns = function() { return numberOfColumns; };
    // Get the number of rows.
    this.getNumberOfRows = function() { return numberOfRows; };
    // Get the number of slices.
    this.getNumberOfSlices = function() { return (numberOfSlices || 1.0); };
};
// Get the size of a slice.
dwv.image.Size.prototype.getSliceSize = function() {
    return this.getNumberOfColumns()*this.getNumberOfRows();
};
// Get the total size.
dwv.image.Size.prototype.getTotalSize = function() {
    return this.getSliceSize()*this.getNumberOfSlices();
};
// Check for equality.
dwv.image.Size.prototype.equals = function(rhs) {
    return rhs !== null &amp;&amp;
        this.getNumberOfColumns() === rhs.getNumberOfColumns() &amp;&amp;
        this.getNumberOfRows() === rhs.getNumberOfRows() &amp;&amp;
        this.getNumberOfSlices() === rhs.getNumberOfSlices();
};
// Check that coordinates are within bounds.
dwv.image.Size.prototype.isInBounds = function( i, j, k ) {
    if( i &lt; 0 || i &gt; this.getNumberOfColumns() - 1 ||
        j &lt; 0 || j &gt; this.getNumberOfRows() - 1 ||
        k &lt; 0 || k &gt; this.getNumberOfSlices() - 1 ) return false;
    return true;
};

/**
* @class Image Spacing class. 
* Supports 2D and 3D images.
* @param columnSpacing The column spacing (number).
* @param rowSpacing The row spacing (number).
* @param sliceSpacing The slice spacing (number).
*/
dwv.image.Spacing = function( columnSpacing, rowSpacing, sliceSpacing )
{
    // Get the column spacing.
    this.getColumnSpacing = function() { return columnSpacing; };
    // Get the row spacing.
    this.getRowSpacing = function() { return rowSpacing; };
    // Get the slice spacing.
    this.getSliceSpacing = function() { return (sliceSpacing || 1.0); };
};
// Check for equality.
dwv.image.Spacing.prototype.equals = function(rhs) {
    return rhs !== null &amp;&amp;
        this.getColumnSpacing() === rhs.getColumnSpacing() &amp;&amp;
        this.getRowSpacing() === rhs.getRowSpacing() &amp;&amp;
        this.getSliceSpacing() === rhs.getSliceSpacing();
};

/**
* @class Image class.
* @param size The sizes of the image.
* @param spacing The spacings of the image.
* @param _buffer The image data.
* Usable once created, optional are:
* - rescale slope and intercept (default 1:0), 
* - photometric interpretation (default MONOCHROME2),
* - planar configuration (default RGBRGB...).
*/
dwv.image.Image = function(size, spacing, buffer, slicePositions)
{
    // Rescale slope.
    var rescaleSlope = 1;
    // Rescale intercept.
    var rescaleIntercept = 0;
    // Photometric interpretation (MONOCHROME, RGB...)
    var photometricInterpretation = &quot;MONOCHROME2&quot;;
    // Planar configuration for RGB data (0:RGBRGBRGBRGB... or 1:RRR...GGG...BBB...)
    var planarConfiguration = 0;
    // Meta information
    var meta = {};
    
    // original buffer.
    var originalBuffer = new Int16Array(buffer);
    
    // check slice positions.
    if( typeof(slicePositions) === &#x27;undefined&#x27; ) slicePositions = [[0,0,0]];
    
    // data range.
    var dataRange = null;
    // histogram.
    var histogram = null;
     
    // Get the size of the image.
    this.getSize = function() { return size; };
    // Get the spacing of the image.
    this.getSpacing = function() { return spacing; };
    // Get the data buffer of the image. TODO dangerous...
    this.getBuffer = function() { return buffer; };
    // Get the slice positions.
    this.getSlicePositions = function() { return slicePositions; };
    
    // Get the rescale slope.
    this.getRescaleSlope = function() { return rescaleSlope; };
    // Set the rescale slope.
    this.setRescaleSlope = function(val) { rescaleSlope = val; };
    // Get the rescale intercept.
    this.getRescaleIntercept = function() { return rescaleIntercept; };
    // Set the rescale intercept.
    this.setRescaleIntercept = function(val) { rescaleIntercept = val; };
    // Get the photometricInterpretation of the image.
    this.getPhotometricInterpretation = function() { return photometricInterpretation; };
    // Set the photometricInterpretation of the image.
    this.setPhotometricInterpretation = function(interp) { photometricInterpretation = interp; };
    // Get the planarConfiguration of the image.
    this.getPlanarConfiguration = function() { return planarConfiguration; };
    // Set the planarConfiguration of the image.
    this.setPlanarConfiguration = function(config) { planarConfiguration = config; };

    // Get the meta information of the image.
    this.getMeta = function() { return meta; };
    // Set the meta information of the image.
    this.setMeta = function(rhs) { meta = rhs; };

    // Get value at offset. Warning: No size check...
    this.getValueAtOffset = function(offset) {
        return buffer[offset];
    };
    // Clone the image.
    this.clone = function()
    {
        var copy = new dwv.image.Image(this.getSize(), this.getSpacing(), originalBuffer, slicePositions);
        copy.setRescaleSlope(this.getRescaleSlope());
        copy.setRescaleIntercept(this.getRescaleIntercept());
        copy.setPhotometricInterpretation(this.getPhotometricInterpretation());
        copy.setPlanarConfiguration(this.getPlanarConfiguration());
        copy.setMeta(this.getMeta());
        return copy;
    };
    // Append a slice to the image.
    this.appendSlice = function(rhs)
    {
        // check input
        if( rhs === null )
            throw new Error(&quot;Cannot append null slice&quot;);
        if( rhs.getSize().getNumberOfSlices() !== 1 )
            throw new Error(&quot;Cannot append more than one slice&quot;);
        if( size.getNumberOfColumns() !== rhs.getSize().getNumberOfColumns() )
            throw new Error(&quot;Cannot append a slice with different number of columns&quot;);
        if( size.getNumberOfRows() !== rhs.getSize().getNumberOfRows() )
            throw new Error(&quot;Cannot append a slice with different number of rows&quot;);
        if( photometricInterpretation !== rhs.getPhotometricInterpretation() )
            throw new Error(&quot;Cannot append a slice with different photometric interpretation&quot;);
        // all meta should be equal
        for( var key in meta ) {
            if( meta[key] !== rhs.getMeta()[key] )
                throw new Error(&quot;Cannot append a slice with different &quot;+key);
        }
        
        // find index where to append slice
        var closestSliceIndex = 0;
        var slicePosition = rhs.getSlicePositions()[0];
        var minDiff = Math.abs( slicePositions[0][2] - slicePosition[2] );
        var diff = 0;
        for( var i = 0; i &lt; slicePositions.length; ++i )
        {
            diff = Math.abs( slicePositions[i][2] - slicePosition[2] );
            if( diff &lt; minDiff ) 
            {
                minDiff = diff;
                closestSliceIndex = i;
            }
        }
        diff = slicePositions[closestSliceIndex][2] - slicePosition[2];
        var newSliceNb = ( diff &gt; 0 ) ? closestSliceIndex : closestSliceIndex + 1;
        
        // new size
        var newSize = new dwv.image.Size(size.getNumberOfColumns(),
                size.getNumberOfRows(),
                size.getNumberOfSlices() + 1 );
        
        // calculate slice size
        var mul = 1;
        if( photometricInterpretation === &quot;RGB&quot; ) mul = 3;
        var sliceSize = mul * size.getSliceSize();
        
        // create the new buffer
        var newBuffer = new Int16Array(sliceSize * newSize.getNumberOfSlices());
        
        // append slice at new position
        if( newSliceNb === 0 )
        {
            newBuffer.set(rhs.getBuffer());
            newBuffer.set(buffer, sliceSize);
        }
        else if( newSliceNb === size.getNumberOfSlices() )
        {
            newBuffer.set(buffer);
            newBuffer.set(rhs.getBuffer(), size.getNumberOfSlices() * sliceSize);
        }
        else
        {
            var offset = newSliceNb * sliceSize;
            newBuffer.set(buffer.subarray(0, offset - 1));
            newBuffer.set(rhs.getBuffer(), offset);
            newBuffer.set(buffer.subarray(offset), offset + sliceSize);
        }
        
        // update slice positions
        slicePositions.splice(newSliceNb, 0, slicePosition);
        
        // copy to class variables
        size = newSize;
        buffer = newBuffer;
        originalBuffer = new Int16Array(newBuffer);
    };
    // Get the data range.
    this.getDataRange = function() { 
        if( !dataRange ) dataRange = this.calculateDataRange();
        return dataRange;
    };
    // Get the histogram.
    this.getHistogram = function() { 
        if( !histogram ) histogram = this.calculateHistogram();
        return histogram;
    };
};

/**
 * Get the value of the image at a specific coordinate.
 * @param i The X index.
 * @param j The Y index.
 * @param k The Z index.
 * @returns The value at the desired position.
 * Warning: No size check...
 */
dwv.image.Image.prototype.getValue = function( i, j, k )
{
    return this.getValueAtOffset( i +
        ( j * this.getSize().getNumberOfColumns() ) +
        ( k * this.getSize().getSliceSize()) );
};

/**
 * Get the value of the image at a specific offset.
 * @param offset The offset in the buffer. 
 * @returns The value at the desired offset.
 * Warning: No size check...
 */
dwv.image.Image.prototype.getRescaledValueAtOffset = function( offset )
{
    return (this.getValueAtOffset(offset)*this.getRescaleSlope())+this.getRescaleIntercept();
};

/**
 * Get the value of the image at a specific coordinate.
 * @param i The X index.
 * @param j The Y index.
 * @param k The Z index.
 * @returns The value at the desired position.
 * Warning: No size check...
 */
dwv.image.Image.prototype.getRescaledValue = function( i, j, k )
{
    return (this.getValue(i,j,k)*this.getRescaleSlope())+this.getRescaleIntercept();
};

/**
 * Calculate the raw image data range.
 * @returns The range {min, max}.
 */
dwv.image.Image.prototype.calculateDataRange = function()
{
    var min = this.getValueAtOffset(0);
    var max = min;
    var value = 0;
    for(var i=0; i &lt; this.getSize().getTotalSize(); ++i)
    {    
        value = this.getValueAtOffset(i);
        if( value &gt; max ) { max = value; }
        if( value &lt; min ) { min = value; }
    }
    return { &quot;min&quot;: min, &quot;max&quot;: max };
};

/**
 * Calculate the image data range after rescale.
 * @returns The range {min, max}.
 */
dwv.image.Image.prototype.getRescaledDataRange = function()
{
    var rawRange = this.getDataRange();
    return { &quot;min&quot;: rawRange.min*this.getRescaleSlope()+this.getRescaleIntercept(),
        &quot;max&quot;: rawRange.max*this.getRescaleSlope()+this.getRescaleIntercept()};
};

/**
 * Calculate the histogram of the image.
 * @returns An array representing the histogram.
 */
dwv.image.Image.prototype.calculateHistogram = function()
{
    var histo = [];
    var histoPlot = [];
    var value = 0;
    var size = this.getSize().getTotalSize();
    for(var i=0; i &lt; size; ++i)
    {    
        value = this.getRescaledValueAtOffset(i);
        histo[value] = histo[value] || 0;
        histo[value] += 1;
    }
    // generate data for plotting
    var min = this.getRescaledDataRange().min;
    var max = this.getRescaledDataRange().max;
    for(var j=min; j &lt; max; ++j)
    {    
        value = histo[j] || 0;
        histoPlot.push([j, value]);
    }
    return histoPlot;
};

/**
 * Convolute the image with a given 2D kernel.
 * @param weights The weights of the 2D kernel.
 * @returns The convoluted image.
 * 
 * Note: Uses the raw buffer values.
 */
dwv.image.Image.prototype.convolute2D = function(weights)
{
    var newImage = this.clone();
    var newBuffer = newImage.getBuffer();

    var side = Math.round(Math.sqrt(weights.length));
    var halfSide = Math.floor(side/2);
    
    var ncols = this.getSize().getNumberOfColumns();
    var nrows = this.getSize().getNumberOfRows();
    var nslices = this.getSize().getNumberOfSlices();
    
    // loop vars
    var dstOff = 0;
    var newValue = 0;
    var sci = 0;
    var scj = 0;
    var srcOff = 0;
    var wt = 0;
    
    // go through the destination image pixels
    for (var k=0; k&lt;nslices; k++) {
        for (var j=0; j&lt;nrows; j++) {
            for (var i=0; i&lt;ncols; i++) {
                dstOff = k*ncols*nrows + j*ncols + i;
                // calculate the weighed sum of the source image pixels that
                // fall under the convolution matrix
                newValue = 0;
                for (var cj=0; cj&lt;side; cj++) {
                    for (var ci=0; ci&lt;side; ci++) {
                        sci = i + ci - halfSide;
                        scj = j + cj - halfSide;
                        if (sci &gt;= 0 &amp;&amp; sci &lt; ncols &amp;&amp; scj &gt;= 0 &amp;&amp; scj &lt; nrows ) {
                            srcOff = k*ncols*nrows + scj*ncols + sci;
                            wt = weights[cj*side+ci];
                            newValue += this.getValueAtOffset(srcOff) * wt;
                        }
                    }
                }
                newBuffer[dstOff] = newValue;
            }
        }
    }
    return newImage;
};

/**
 * Transform an image using a specific operator.
 * @param operator The operator to use when transforming.
 * @returns The transformed image.
 * 
 * Note: Uses the raw buffer values.
 */
dwv.image.Image.prototype.transform = function(operator)
{
    var newImage = this.clone();
    var newBuffer = newImage.getBuffer();
    for(var i=0; i &lt; this.getSize().getTotalSize(); ++i)
    {   
        newBuffer[i] = operator( newImage.getValueAtOffset(i) );
    }
    return newImage;
};

/**
 * Compose this image with another one and using a specific operator.
 * @param rhs The image to compose with.
 * @param operator The operator to use when composing.
 * @returns The composed image.
 * 
 * Note: Uses the raw buffer values.
 */
dwv.image.Image.prototype.compose = function(rhs, operator)
{
    var newImage = this.clone();
    var newBuffer = newImage.getBuffer();
    for(var i=0; i &lt; this.getSize().getTotalSize(); ++i)
    {   
        // using the operator on the local buffer, i.e. the latest (not original) data
        newBuffer[i] = Math.floor( operator( this.getValueAtOffset(i), rhs.getValueAtOffset(i) ) );
    }
    return newImage;
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
