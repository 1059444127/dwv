<!DOCTYPE html>
<html>
<head>
<title>DICOM Generator</title>
<meta charset="UTF-8">
<script type="text/javascript" src="../../src/dicom/dicomParser.js"></script>
<script type="text/javascript" src="../../src/dicom/dicomWriter.js"></script>
<script type="text/javascript" src="../../src/dicom/dictionary.js"></script>
<script type="text/javascript">
function getDicomElement(tagName)
{
   var group = null;
   var element = null;
   var dict = dwv.dicom.dictionary;
   var keys0 = Object.keys(dict);
   var keys1 = null;
   // label for nested loop break
   outLabel:
   // search through dictionary
   for ( var k0 = 0, lenK0 = keys0.length; k0 < lenK0; ++k0 ) {
       group = keys0[k0];
       keys1 = Object.keys( dict[group] );
       for ( var k1 = 0, lenK1 = keys1.length; k1 < lenK1; ++k1 ) {
           element = keys1[k1];
           if ( dict[group][element][2] === tagName ) {
               break outLabel;
           }
       }
   }
   return {
     element: element,
     group: group,
     vr: dict[group][element][0],
     vl: dict[group][element][1]
   }
}
function setElementValue(element, value) {
    
    var size = 0;
    // value length
    var vl = 1;
    
    if ( element.vr === "SQ") {
        
        // default vl
        vl = 0;
        element.value = {};

        if ( value !== null ) {
	        var elements = {};
	        var name;
	        
	        // sequence elements
	        var sqElement;
	        var keys = Object.keys(value);
	        for ( var i = 0, len = keys.length; i < len; ++i )
	        {
	            sqElement = getDicomElement(keys[i]);
	            size += setElementValue(sqElement, value[keys[i]]);
	            
	            name = dwv.dicom.getGroupElementKey(sqElement.group, sqElement.element);
	            elements[name] = sqElement;
	        }
	        
	        // item
	        var itemElement =  {
	               element: "0xE000",
	               group: "0xFFFE",
	               vr: "NONE",
	               vl: size,
	               value: []
	           };
	        name = dwv.dicom.getGroupElementKey(itemElement.group, itemElement.element);
	        elements[name] = itemElement;
	        
	        // add the size of item
	        vl = itemElement.vl + dwv.dicom.getDataElementPrefixByteSize("NONE"); 
	        element.value = [elements];
        }
        
        element.vl = vl;
    }
    else {
        if (typeof value !== "undefined" && typeof value.length !== "undefined") {
            vl = value.length;
        }
        
        size = vl + dwv.dicom.getDataElementPrefixByteSize(element.vr);

        if ( element.vr === "US" || element.vr === "OW") {
            vl *= Uint16Array.BYTES_PER_ELEMENT;
	    }
	    else if ( element.vr === "SS") {
	        vl *= Int16Array.BYTES_PER_ELEMENT;
	    }
	    else if ( element.vr === "UL") {
	        vl *= Uint32Array.BYTES_PER_ELEMENT;
	    }
	    else if ( element.vr === "SL") {
	        vl *= Int32Array.BYTES_PER_ELEMENT;
	    }
	    else if ( element.vr === "FL") {
	        vl *= Float32Array.BYTES_PER_ELEMENT;
	    }
	    else if ( element.vr === "FD") {
	        vl *= Float64Array.BYTES_PER_ELEMENT;
	    }
        
        element.value = [value];
        element.vl = vl;
    }
    
    return size;
}
function generate()
{
    var tags = JSON.parse(document.getElementById('tags').value);
    var keys = Object.keys(tags);
    var elements = {};
    var element;
    var name;
    var value;
    for ( var i = 0, len = keys.length; i < len; ++i )
    {
        element = getDicomElement(keys[i]);
        setElementValue(element, tags[keys[i]]);
        
        name = dwv.dicom.getGroupElementKey(element.group, element.element);
        elements[name] = element;
    }
    
    // pixels
    var numberOfRows = ( typeof tags.Rows === 'undefined' ) ? 64 : tags.Rows;
    var numberOfColumns = ( typeof tags.Columns === 'undefined' ) ? 64 : tags.Columns;
    var pixels = new Uint16Array(numberOfRows*numberOfColumns);
    pixels.fill(100);
    for ( var j = 0; j < numberOfRows; ++j ) {
        var jc = Math.abs( j - (numberOfRows/2) );
	    for ( var i = 0; i < numberOfColumns; ++i ) {
	        var ic = Math.abs( i - (numberOfColumns/2) );
	        if ( jc < 10 && ic < 10) {
	            pixels[numberOfColumns*j + i] = i * j;
	        }
	    }
    }
    var pixVL = dwv.dicom.getDataElementPrefixByteSize("OW") +
       (Uint16Array.BYTES_PER_ELEMENT * numberOfRows * numberOfColumns);
    elements["x7FE00010"] = {
        element: "0x0010",
        group: "0x7FE0",
        vr: "OW",
        vl: pixVL,
        value: pixels
    };
    
    var writer = new dwv.dicom.DicomWriter();
    var blob = new Blob([writer.getBuffer(elements)], {type: 'application/dicom'});
    
    var element = document.getElementById("generate");
    element.download = "dwv-generated.dcm";
    element.href = URL.createObjectURL(blob);
}
function saveFile()
{
    var tags = JSON.stringify(JSON.parse(document.getElementById('tags').value));
    
    var element = document.getElementById("save");
    element.download = "tags.json";
    element.href = "data:application/json," + tags;
}
</script>
<style>
body { font-family: Arial; }
textarea { width:100%; }
.button {
    background: #E3E3E3;
    padding: 3px;
    text-align: center;
    border-radius: 3px;
    color: black;
    text-decoration : none;
}
</style>
</head>

<body>

<h1>DICOM Generator</h1>

<p>Simple DICOM data generator from json tags. 
Mainly used for generating test data, <b>use at your own risks!</b>

Only tested with explicit data (transfer syntax: <code>1.2.840.10008.1.2.1</code>). 
Sequences can have a <code>null</code> value.
</p>

<form name="genform">
<fieldset>
<textarea id="tags" rows="20">
{
  "FileMetaInformationGroupLength": 28,
  "TransferSyntaxUID": "1.2.840.10008.1.2.1",
  "Modality": "MR",
  "PatientName": "dwv-patient-name",
  "PerformingPhysicianName": "",
  "dBdt": "0",
  "PhotometricInterpretation": "MONOCHROME2",
  "SamplesPerPixel": 1,
  "PixelRepresentation": 0,
  "Rows": 64,
  "Columns": 64,
  "BitsAllocated": 16,
  "BitsStored": 12,
  "HighBit": 11,
  "ReferencedImageSequence": { 
    "ReferencedSOPClassUID": "1.2.840.10008.5.1.4.1.1.4",
    "ReferencedSOPInstanceUID": "1.3.12.2.1107.5.2.32.35162.2012021515511672669154094"
  }
}
</textarea>
<a href="#" id="save" class="button" onclick="saveFile();">Save Config</a>
<a href="#" id="generate" class="button" onclick="generate();">Generate</a>
</fieldset>
</form>

</body>
</html>
