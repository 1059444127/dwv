<html>

<head>
<title>DICOM Web Viewer</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<link rel="stylesheet" href="style.css">
</head>

<body>
     
<script type="text/javascript" src="js/reader/LocalFileReader.js"></script>
<script type="text/javascript" src="js/dicom/DicomInputStreamReader.js"></script>
<script type="text/javascript" src="js/dicom/DicomElement.js"></script>
<script type="text/javascript" src="js/dicom/DicomParser.js"></script>
<script type="text/javascript" src="js/dicom/DicomImage.js"></script>
<script type="text/javascript" src="js/dicom/LookupTable.js"></script>
<script type="text/javascript" src="js/tools/rect.js"></script>
<script type="text/javascript" src="js/tools/roi.js"></script>
<script type="text/javascript" src="js/tools/line.js"></script>
<script type="text/javascript" src="js/tools/circle.js"></script>
<script type="text/javascript" src="js/tools/windowLevel.js"></script>

<script type="text/javascript">

    // DICOM values
    var image;
    
    var lookupTable;
    var huLookupTable; 
    var lookupObj;
       
    var pixelBuffer;
    var imageLoaded=0;
    
    // The active tool instance.
    var selectedTool = false;
    var defaultTool = 'windowLevel';
    // This object holds the implementation of each drawing tool.
    var tools = {};
    var baseCanvas;
    var baseContext;    
    var canvas;
    var context;    
    var myImageData;
    
    // style
    var fontSize = 12;
    var fontStr = "normal "+fontSize+"px sans-serif";
    var lineHeight = fontSize + fontSize/5;
    var lineColor = "yellow";
    var textColor = "#fff";

    function mouseOverColor()
    {
        document.body.style.cursor="pointer";
    }
    
    function mouseOutColor()
    {
        document.body.style.cursor="auto";
    }
    
    function setLineColor(color)
    {
        // set global var
        lineColor = color;
        // reset borders
        var tr = document.getElementById("colours");
        var tds = tr.getElementsByTagName("td");
        for (var i = 0; i < tds.length; i++)
        {
            tds[i].style.border = "#fff solid 2px";
        }
        // set selected border
        var td = document.getElementById(color);
        td.style.border = "#00f solid 2px";
    }
    
    function initCanvas()
    {
        // Find the canvas element.
        baseCanvas = document.getElementById('imageView');
        if (!baseCanvas)
        {
            alert('Error: I cannot find the canvas element!');
            return;
        }

        if (!baseCanvas.getContext)
        {
            alert('Error: no canvas.getContext!');
            return;
        }

        // Get the 2D canvas context.
        baseContext = baseCanvas.getContext('2d');
        if (!baseContext)
        {
            alert('Error: failed to getContext!');
            return;
        }

        // Add the temporary canvas.
        var container = baseCanvas.parentNode;
        canvas = document.createElement('canvas');
        if (!canvas)
        {
            alert('Error: I cannot create a new canvas element!');
            return;
        }

        baseCanvas.width = image.getSize()[0];
        baseCanvas.height = image.getSize()[1];
        
        canvas.id = 'imageTemp';
        canvas.width = baseCanvas.width;
        canvas.height = baseCanvas.height;
        container.appendChild(canvas);
        context = canvas.getContext('2d');
    }
    
    function initTools()
    {
        // tool list
        tools.rect = tools_rect;
        tools.roi = tools_roi;
        tools.line = tools_line;
        tools.circle = tools_circle;
        tools.windowLevel = tools_windowLevel;
    
        // Get the tool select input.
        var tool_select = document.getElementById('dtool');
        if (!tool_select)
        {
            alert('Error: failed to get the dtool element!');
            return;
        }
        tool_select.addEventListener('change', event_tool_change, false);

        // Activate the default tool.
        if (tools[defaultTool])
        {
            selectedTool = new tools[defaultTool]();
            tool_select.value = defaultTool;
        }
    }

    // The event handler for any changes made to the tool selector.
    function event_tool_change(event)
    {
        if (tools[this.value])
        {
            selectedTool = new tools[this.value]();
        }
    }

    // This function draws the #imageTemp canvas on top of #imageView,
    // after which #imageTemp is cleared. This function is called each time when the
    // user completes a drawing operation.
    function img_update() 
    {
        baseContext.drawImage(canvas, 0, 0);
        context.clearRect(0, 0, canvas.width, canvas.height);
    } 

    // The general-purpose event handler. This function just determines the mouse 
    // position relative to the canvas element.
    function ev_canvas(event)
    {
        if (event.layerX || event.layerX == 0)
        { 
            // Firefox
            event._x = event.layerX;
            event._y = event.layerY;
        }
        else if (event.offsetX || event.offsetX == 0)
        {
            // Opera
            event._x = event.offsetX;
            event._y = event.offsetY;
        }

        if(event._x >= 0 
            && event._y >= 0 
            && event._x < image.getSize()[0] 
            && event._y < image.getSize()[1] )
        {
            // Call the event handler of the tool.
            var func = selectedTool[event.type];
            if (func)
            {
                func(event);
            }
        }
    }

    function loadDicom(evt) 
    {
        file = evt.target.files[0]
        
        var myreader = new FileReader();
        myreader.onload = function() {
            return function(e) {
              wadoURL = e.target.result
              parseAndLoadDicom();
              var span = document.createElement('div');
              span.innerHTML = ['<p><b>', e.target.result.length, '</b></p>'].join('');
              document.getElementById('tagSearch').insertBefore(span, null);
            };
        }();
        myreader.readAsBinaryString(file);
    }
    
    function getContextPath()
    {
        var path = top.location.pathname;
        if (document.all)
        {
            path = path.replace(/\\/g,"/");
        }
        path = path.substr(0,path.lastIndexOf("/")+1);        
        return path;
    }
    
    function parseAndLoadDicom()
    {    
        var reader=new DicomInputStreamReader();    
        reader.readDicom(wadoURL);
        var dicomBuffer=reader.getInputBuffer();
        var dicomReader=reader.getReader();
        var dicomParser=new DicomParser(dicomBuffer,dicomReader);
        dicomParser.parseAll();     
        
        // tag list table      
        var table = document.getElementById("tagList")
        
        var numberOfRows;
        var numberOfColumns;
        var rowSpacing;
        var columnSpacing;
        var windowWidth;
        var windowCenter;
        var rescaleIntercept;
        var rescaleSlope;
        
        var elementindex=0;
        for(;elementindex<dicomParser.dicomElement.length;elementindex++)
        {
            var dicomElement=dicomParser.dicomElement[elementindex];            
            if(dicomElement.name=="numberOfRows")
            {
                numberOfRows=dicomElement.value[0];
            }
            else if(dicomElement.name=="numberOfColumns")
            {
                numberOfColumns=dicomElement.value[0];
            }
            else if(dicomElement.name=="pixelSpacing")
            {
                rowSpacing=parseFloat(dicomElement.value[0]);    
                columnSpacing=parseFloat(dicomElement.value[1]);    
            }
            else if(dicomElement.name=="windowWidth")
            {
                windowWidth=dicomElement.value[0];
            }
            else if(dicomElement.name=="windowCenter")
            {
                windowCenter=dicomElement.value[0];            
            }
            else if(dicomElement.name=="rescaleSlope")
            {
                rescaleSlope=parseInt(dicomElement.value);    
            }
            else if(dicomElement.name=="rescaleIntercept")
            {
                rescaleIntercept=parseInt(dicomElement.value);
            }

            var lastRow = table.rows.length;
            var row = table.insertRow(lastRow);
            var cell0 = row.insertCell(0);
            cell0.appendChild(document.createTextNode(dicomElement.group+", "+dicomElement.element));
            var cell1 = row.insertCell(1);
            cell1.appendChild(document.createTextNode(dicomElement.name));
            var cell2 = row.insertCell(2);
            cell2.appendChild(document.createTextNode(dicomElement.value));
        } 
               
        pixelBuffer=dicomParser.pixelBuffer;
        
        image = new DicomImage(
            [numberOfRows, numberOfColumns],
            [rowSpacing, columnSpacing]);
            
        lookupObj = new LookupTable();
        lookupObj.setData(windowCenter,windowWidth,rescaleSlope,rescaleIntercept);
        lookupObj.calculateHULookup();
        
        initCanvas();
        
        baseContext.fillRect(0,0,numberOfRows,numberOfColumns);    
        myImageData = baseContext.getImageData(0,0,numberOfRows,numberOfColumns);        
        genImage();        
        imageLoaded=1;
        
        initTools();
        setLineColor(lineColor);
        
        // Attach the mousedown, mousemove and mouseup event listeners.
        canvas.addEventListener('mousedown', ev_canvas, false);
        canvas.addEventListener('mousemove', ev_canvas, false);
        canvas.addEventListener('mouseup',   ev_canvas, false);
    }
    
    function genImage()
    {        
        lookupObj.calculateLookup();
        var n=0;    
        for(var yPix=0; yPix<image.getSize()[1]; yPix++)
        {
            for(var xPix=0; xPix<image.getSize()[0];xPix++)
            {        
                var offset = (yPix * image.getSize()[0] + xPix) * 4;                    
                var pxValue=lookupObj.ylookup[pixelBuffer[n]];    
                n++;               
                myImageData.data[offset] = parseInt(pxValue);
                myImageData.data[offset+1] = parseInt(pxValue);
                myImageData.data[offset+2] = parseInt(pxValue);
            }
        }            
        baseContext.putImageData(myImageData, 0,0);
    }    
</script>

<!-- Header -->
<h1>DICOM Web Viewer (<a href="https://github.com/ivmartel/dwv">dwv</a>)</h1>

<!-- Left -->
<div id="left">
Tool: <select id="dtool">
  <option value="windowLevel">Window/Level</option>
  <option value="rect">Draw: Rectangle</option>
  <option value="circle">Draw: Circle</option>
  <option value="roi">Draw: ROI</option>
  <option value="line">Draw: Line</option>
</select>

<br>&nbsp;

<br>Color: 
<table name="colourChooser" class="colourChooser">
<tr id="colours" onmouseover="mouseOverColor()" onmouseout="mouseOutColor()">
<td id="black" onclick="setLineColor('black')">&nbsp;</td>
<td id="white" onclick="setLineColor('white')">&nbsp;</td>
<td id="red" onclick="setLineColor('red')">&nbsp;</td>
<td id="green" onclick="setLineColor('green')">&nbsp;</td>
<td id="blue" onclick="setLineColor('blue')">&nbsp;</td>
<td id="yellow" onclick="setLineColor('yellow')">&nbsp;</td>
<td id="lime" onclick="setLineColor('lime')">&nbsp;</td>
<td id="fuchsia" onclick="setLineColor('fuchsia')">&nbsp;</td>
</tr>
</table>

<div id="presetSelector"></div>
<script type="text/javascript">getPresetSelector();</script>

</div>

<!-- Container -->
<div id="container">
<canvas id="imageView" width="200" height="200" ></canvas>
</div>

<!-- Right -->
<div id="right">
<form>
Path: <input type="file" id="files" name="files[]" multiple />
</form>

<script type="text/javascript">
    document.getElementById('files').addEventListener('change', loadDicom, false);
</script>

<form>
Search Tags: <input type="text" id="tagSearch" name="tagSearch" multiple />
<input type="submit" value="Submit" />
</form>

<table id="tagList" class="tagList">
<tr>
<th>Tag</th>
<th>Name</th>
<th>Value</th>
</tr>
</table>

</div>

</body>
</html>

