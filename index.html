<html>

<head>
<title>DICOM Web Viewer</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<link rel="stylesheet" href="style.css">
</head>

<body>
     
<script type="text/javascript" src="js/reader/LocalFileReader.js"></script>
<script type="text/javascript" src="js/dicom/DicomInputStreamReader.js"></script>
<script type="text/javascript" src="js/dicom/DicomElement.js"></script>
<script type="text/javascript" src="js/dicom/DicomParser.js"></script>
<script type="text/javascript" src="js/dicom/LookupTable.js"></script>
<script type="text/javascript" src="js/tools/rect.js"></script>
<script type="text/javascript" src="js/tools/roi.js"></script>
<script type="text/javascript" src="js/tools/line.js"></script>
<script type="text/javascript" src="js/tools/circle.js"></script>
<script type="text/javascript" src="js/tools/windowLevel.js"></script>

<script type="text/vbscript">
Function BinFileReaderImpl_IE_VBAjaxLoader(fileName)
    Dim xhr
    Set xhr = CreateObject("Microsoft.XMLHTTP")
    xhr.Open "GET", fileName, False
    xhr.setRequestHeader "Accept-Charset", "x-user-defined"
    xhr.send
    Dim byteArray()
    if xhr.Status = 200 Then
        Dim byteString
        Dim i
        byteString=xhr.responseBody
        ReDim byteArray(LenB(byteString))
        For i = 1 To LenB(byteString)
            byteArray(i-1) = AscB(MidB(byteString, i, 1))
        Next
    End If
    BinFileReaderImpl_IE_VBAjaxLoader=byteArray
End Function
</script>
<script type="text/javascript">

    var wadoURL;
    var wc;
    var ww;
    var windowCenter;
    var windowWidth;
    var rescaleSlope;
    var rescaleIntercept;
    var spacingX;
    var spacingY;
    var lookupTable;
    var huLookupTable;    
    var pixelBuffer = new Array(512*512*2);
    var imageLoaded=0;
    var row=512;
    var column=512;
    var lookupObj;
    
    // The active tool instance.
    var selectedTool = false;
    var defaultTool = 'windowLevel';
    // This object holds the implementation of each drawing tool.
    var tools = {};
    var baseCanvas;
    var baseContext;    
    var canvas;
    var context;    
    var myImageData;
    
    // style
    var fontSize = 12;
    var fontStr = "normal "+fontSize+"px sans-serif";
    var lineHeight = fontSize + fontSize/5;
    var lineColor = "yellow";
    var textColor = "#fff";

    String.prototype.replaceAll = function(pcFrom, pcTo){
        var i = this.indexOf(pcFrom);
        var c = this;
        while (i > -1)
        {
            c = c.replace(pcFrom, pcTo);
            i = c.indexOf(pcFrom);
        }
        return c;
    }
    
    function mouseOverColor()
    {
        document.body.style.cursor="pointer";
    }
    
    function setLineColor(color)
    {
        // set global var
        lineColor = color;
        // reset borders
        var tr = document.getElementById("colours");
        var tds = tr.getElementsByTagName("td");
        for (var i = 0; i < tds.length; i++)
        {
            tds[i].style.border = "#fff solid 2px";
        }
        // set selected border
        var td = document.getElementById(color);
        td.style.border = "#00f solid 2px";
    }
    
    function initCanvas()
    {
        // Find the canvas element.
        baseCanvas = document.getElementById('imageView');
        if (!baseCanvas)
        {
            alert('Error: I cannot find the canvas element!');
            return;
        }

        if (!baseCanvas.getContext)
        {
            alert('Error: no canvas.getContext!');
            return;
        }

        // Get the 2D canvas context.
        baseContext = baseCanvas.getContext('2d');
        if (!baseContext)
        {
            alert('Error: failed to getContext!');
            return;
        }

        // Add the temporary canvas.
        var container = baseCanvas.parentNode;
        canvas = document.createElement('canvas');
        if (!canvas)
        {
            alert('Error: I cannot create a new canvas element!');
            return;
        }

        canvas.id = 'imageTemp';
        canvas.width = baseCanvas.width;
        canvas.height = baseCanvas.height;
        container.appendChild(canvas);
        context = canvas.getContext('2d');
    }
    
    function initTools()
    {
        // tool list
        tools.rect = tools_rect;
        tools.roi = tools_roi;
        tools.line = tools_line;
        tools.circle = tools_circle;
        tools.windowLevel = tools_windowLevel;
    
        // Get the tool select input.
        var tool_select = document.getElementById('dtool');
        if (!tool_select)
        {
            alert('Error: failed to get the dtool element!');
            return;
        }
        tool_select.addEventListener('change', event_tool_change, false);

        // Activate the default tool.
        if (tools[defaultTool])
        {
            selectedTool = new tools[defaultTool]();
            tool_select.value = defaultTool;
        }
    }

    // The event handler for any changes made to the tool selector.
    function event_tool_change(event)
    {
        if (tools[this.value])
        {
            selectedTool = new tools[this.value]();
        }
    }

    // This function draws the #imageTemp canvas on top of #imageView,
    // after which #imageTemp is cleared. This function is called each time when the
    // user completes a drawing operation.
    function img_update() 
    {
        baseContext.drawImage(canvas, 0, 0);
        context.clearRect(0, 0, canvas.width, canvas.height);
    } 

    // The general-purpose event handler. This function just determines the mouse 
    // position relative to the canvas element.
    function ev_canvas(event)
    {
        //event._x = event.pageX - canvas.offsetLeft;
        //event._y = event.pageY - canvas.offsetTop;

        if (event.layerX || event.layerX == 0)
        { 
            // Firefox
            event._x = event.layerX;
            event._y = event.layerY;
        }
        else if (event.offsetX || event.offsetX == 0)
        {
            // Opera
            event._x = event.offsetX;
            event._y = event.offsetY;
        }

        if(event._x>=0 && event._y>=0 && event._x<column && event._y<row)
        {
            // Call the event handler of the tool.
            var func = selectedTool[event.type];
            if (func)
            {
                func(event);
            }
        }
    }

    function changePreset()
    {    
        applyPreset(parseInt(document.getElementById("presetsMenu").options[
            document.getElementById("presetsMenu").selectedIndex].value));
    }
    
    function applyPreset(preset)    
    {    
        switch (preset)
        {
            case 1:    
            wc=windowCenter;
            ww=windowWidth;
            lookupObj.setWindowingdata(wc,ww);        
            genImage();    
            break;
            
            case 2:    
            wc=350;
            ww=40;
            lookupObj.setWindowingdata(wc,ww);        
            genImage();    
            break;
            
            case 3:
            wc=-600;
            ww=1500;
            lookupObj.setWindowingdata(wc,ww);        
            genImage();
            break;
            
            case 4:
            wc=40;
            ww=80;
            lookupObj.setWindowingdata(wc,ww);        
            genImage();
            break;
            
            case 5:
            wc=480;
            ww=2500;
            lookupObj.setWindowingdata(wc,ww);        
            genImage();
            break;
            
            case 6:
            wc=90;
            ww=350;
            lookupObj.setWindowingdata(wc,ww);        
            genImage();
            break;
        }
    }
    
    function showHUvalue(x,y)
    {
        var t = (y*column)+x;        
        
        // style
        context.clearRect(0, 0, 150, 150);
        context.fillStyle = textColor;
        context.font = fontStr
        context.textBaseline = "top";
        context.textAlign = "left";
        
        // text
        context.fillText("X = "+x, 0, 0);
        context.fillText("Y = "+y, 0, lineHeight);
        context.fillText("HU = "+huLookupTable[pixelBuffer[t]], 0, 2*lineHeight);
    }
    
    function showWindowingValue(windowCenter,windowWidth)
    {
        // style
        context.clearRect(canvas.width-150, 0, canvas.width, 150);
        context.fillStyle = textColor;
        context.font = fontStr
        context.textBaseline = "top";
        context.textAlign = "right";
        
        // text
        context.fillText("WindowCenter = "+windowCenter, canvas.width, 0);
        context.fillText("WindowWidth = "+windowWidth, canvas.width, lineHeight);
    }
     
    function loadDicom(evt) 
    {
        //wadoURL= document.htmlForm.wadoURLField.value;             
        file = evt.target.files[0]
        
        var myreader = new FileReader();
        myreader.onload = function() {
            return function(e) {
              wadoURL = e.target.result
              parseAndLoadDicom();
              var span = document.createElement('span');
              span.innerHTML = ['<p><b>', e.target.result.length, '</b></p>'].join('');
              document.getElementById('list').insertBefore(span, null);
            };
        }();
        myreader.readAsBinaryString(file);

        //parseAndLoadDicom();
    }
    
    function getContextPath()
    {
        var path = top.location.pathname;
        if (document.all)
        {
            path = path.replace(/\\/g,"/");
        }
        path = path.substr(0,path.lastIndexOf("/")+1);        
        return path;
    }
    
    function parseAndLoadDicom()
    {    
        var reader=new DicomInputStreamReader();    
        //reader.readDicom("http://"+top.location.host+"/"+getContextPath()+"/dcmstream?wadourl="+wadoURL.replaceAll("&","-"));
        reader.readDicom(wadoURL);
        var dicomBuffer=reader.getInputBuffer();
        var dicomReader=reader.getReader();
        var dicomParser=new DicomParser(dicomBuffer,dicomReader);
        dicomParser.parseAll();     
        
        // tag list table      
        var table = document.getElementById("tagList")
   
        var elementindex=0;
        for(;elementindex<dicomParser.dicomElement.length;elementindex++)
        {
            var dicomElement=dicomParser.dicomElement[elementindex];            
            if(dicomElement.name=="windowWidth")
            {
                windowWidth=ww=dicomElement.value[0];
            }
            else if(dicomElement.name=="windowCenter")
            {
                windowCenter=wc=dicomElement.value[0];            
            }
            else if(dicomElement.name=="rescaleIntercept")
            {
                rescaleIntercept=parseInt(dicomElement.value);
            }
            else if(dicomElement.name=="rescaleSlope")
            {
                rescaleSlope=parseInt(dicomElement.value);    
            }
            else if(dicomElement.name=="pixelSpacing")
            {
                spacingX=parseFloat(dicomElement.value[0]);    
                spacingY=parseFloat(dicomElement.value[1]);    
            }

            var lastRow = table.rows.length;
            var row = table.insertRow(lastRow);
            var cell0 = row.insertCell(0);
            cell0.appendChild(document.createTextNode(dicomElement.group+", "+dicomElement.element));
            var cell1 = row.insertCell(1);
            cell1.appendChild(document.createTextNode(dicomElement.name));
            var cell2 = row.insertCell(2);
            cell2.appendChild(document.createTextNode(dicomElement.value));
        } 
               
        pixelBuffer=dicomParser.pixelBuffer;            
        lookupObj=new LookupTable();
        lookupObj.setData(wc,ww,rescaleSlope,rescaleIntercept);
        lookupObj.calculateHULookup();
        huLookupTable=lookupObj.huLookup;        
        
        initCanvas();
        
        baseContext.fillRect(0,0,512,512);    
        myImageData = baseContext.getImageData(0,0,512,512);        
        genImage();        
        imageLoaded=1;
        
        initTools();
        setLineColor(lineColor);
        
        // Attach the mousedown, mousemove and mouseup event listeners.
        canvas.addEventListener('mousedown', ev_canvas, false);
        canvas.addEventListener('mousemove', ev_canvas, false);
        canvas.addEventListener('mouseup',   ev_canvas, false);
    }
    
    function genImage()
    {        
        lookupObj.calculateLookup();
        lookupTable=lookupObj.ylookup;
        var n=0;    
        for(var yPix=0; yPix<row; yPix++)
        {
            for(var xPix=0; xPix<column;xPix++)
            {        
                var offset = (yPix * column + xPix) * 4;                    
                var pxValue=lookupTable[pixelBuffer[n]];    
                n++;               
                myImageData.data[offset] = parseInt(pxValue);
                myImageData.data[offset+1] = parseInt(pxValue);
                myImageData.data[offset+2] = parseInt(pxValue);
            }
        }            
        baseContext.putImageData(myImageData, 0,0);
    }    
</script>

<!-- Header -->
<h1>DICOM Web Viewer (<a href="https://github.com/ivmartel/dwv">dwv</a>)</h1>

<!-- Left -->
<div id="left">
Tool: <select id="dtool">
  <option value="windowLevel">Window/Level</option>
  <option value="rect">Draw: Rectangle</option>
  <option value="circle">Draw: Circle</option>
  <option value="roi">Draw: ROI</option>
  <option value="line">Draw: Line</option>
</select>

<br>&nbsp;

<br>Color: 
<table name="colourChooser" class="colourChooser">
<tr id="colours" onmouseover="mouseOverColor()" >
<td id="black" onclick="setLineColor('black')">&nbsp;</td>
<td id="white" onclick="setLineColor('white')">&nbsp;</td>
<td id="red" onclick="setLineColor('red')">&nbsp;</td>
<td id="green" onclick="setLineColor('green')">&nbsp;</td>
<td id="blue" onclick="setLineColor('blue')">&nbsp;</td>
<td id="yellow" onclick="setLineColor('yellow')">&nbsp;</td>
<td id="lime" onclick="setLineColor('lime')">&nbsp;</td>
<td id="fuchsia" onclick="setLineColor('fuchsia')">&nbsp;</td>
</tr>
</table>

<br>&nbsp;

<br>Preset:
<select name="presetsMenu" id="presetsMenu" onchange="changePreset();">
<option value="1" selected>Default</option>
<option value="2" >Abdomen</option>
<option value="3" >Lung</option>
<option value="4" >Brain</option>
<option value="5" >Bone</option>
<option value="6" >Head/Neck</option>
</select>

</div>

<!-- Container -->
<div id="container">
<canvas id="imageView" width="512" height="512" ></canvas>
</div>

<!-- Right -->
<div id="right">
<form>
Path: <input type="file" id="files" name="files[]" multiple />
</form>

<script type="text/javascript">
    document.getElementById('files').addEventListener('change', loadDicom, false);
</script>

<form>
Search Tags: <input type="text" id="tagSearch" name="tagSearch" multiple />
<input type="submit" value="Submit" />
</form>

<table id="tagList" class="tagList">
<tr>
<th>Tag</th>
<th>Name</th>
<th>Value</th>
</tr>
</table>

</div>

</body>
</html>

